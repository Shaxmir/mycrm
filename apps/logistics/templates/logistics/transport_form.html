{% extends 'base.html' %}
{% load static %}
{% block content %}
<h2>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h2>

<form method="post">
    {% csrf_token %}
    <label for="id_type">–¢–∏–ø:</label>
    {{ form.type }}

    <label for="id_warehouse">–°–∫–ª–∞–¥:</label>
    {{ form.warehouse }}

    <hr>

    <table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse: collapse;">
        <thead style="background-color: #f0f0f0;">
            <tr>
                <th style="text-align: left; padding: 8px;">–¢–æ–≤–∞—Ä</th>
                <th style="text-align: left; padding: 8px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            </tr>
        </thead>
        <tbody id="products-container">
            <tr class="product-form">
                <td style="padding: 8px;">
                    <div style="display: flex; gap: 4px;">
                        <select name="product" style="flex: 1;">
                            {% for parent_category, subcategories in categories_with_products.items %}
                                <!-- –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è) -->
                                <optgroup label="{{ parent_category.name }}">
                                    {% for subcategory, products in subcategories.items %}
                                        <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è) -->
                                        <option disabled>{{ subcategory.name }}</option>

                                        <!-- –¢–æ–≤–∞—Ä—ã –ø–æ–¥ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ) -->
                                        {% for product in products %}
                                            <option value="{{ product.id }}">
                                                ‚Æë {{ product.name }}
                                                {% if product.thickness %} {{ product.thickness }} –º–º{% endif %}
                                                {% if product.format %} {{ product.format }}{% endif %}
                                                {% if product.grade %} {{ product.grade }}{% endif %}
                                                {% if product.surface %} {{ product.surface }}{% endif %}
                                                {% if product.unit %} {{ product.unit }}{% endif %}
                                            </option>
                                        {% endfor %}
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>

                        <button type="button" class="create-product-button" onclick="openNewProductModal(this)">‚ûï</button>
                    </div>
                </td>
                <td style="padding: 8px;">
                    <input type="number" name="quantity" min="1" required style="width: 100%;">
                </td>
            </tr>
        </tbody>
    </table>

    <button type="button" id="add-product">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    <br><br>
    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<dialog id="newProductModal" style="width: 600px;">
    <form method="dialog" id="newProductForm" enctype="multipart/form-data">
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select name="category" required style="width: 100%;">
            {% for category in categories_with_products %}
                <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
        </select>
        <p>–ù–∞–∑–≤–∞–Ω–∏–µ: <input type="text" name="name" required style="width: 100%;"></p>
        <p>–¢–æ–ª—â–∏–Ω–∞: <input type="number" step="0.01" name="thickness" style="width: 100%;"></p>
        <p>–°–æ—Ä—Ç: <input type="text" name="grade" style="width: 100%;"></p>
        <p>–§–æ—Ä–º–∞—Ç: <input type="text" name="format" style="width: 100%;"></p>
        <p>–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å: <input type="text" name="surface" style="width: 100%;"></p>
        <p>–ö–ª–∞—Å—Å —ç–º–∏—Å—Å–∏–∏: <input type="text" name="emission_class" style="width: 100%;"></p>
        <p>–õ–∏—Å—Ç–æ–≤ –≤ –∫—É–±–æ–º–µ—Ç—Ä–µ: <input type="number" name="sheets_per_cubic_meter" step="0.01" style="width: 100%;"></p>
        <p>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è: <input type="text" name="unit" style="width: 100%;"></p>
        <p>–í–µ—Å: <input type="number" name="weight" step="0.01" style="width: 100%;"></p>
        <p>–ü–ª–æ—â–∞–¥—å: <input type="number" name="area" step="0.01" style="width: 100%;"></p>
        <p>–§–æ—Ç–æ: <input type="file" name="photo" accept="image/*"></p>
        <p>–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞: <input type="number" name="purchase_price" step="0.01" style="width: 100%;"></p>
        <p>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: <input type="number" name="sale_price" step="0.01" style="width: 100%;"></p>
        <p>–ê—Ä—Ç–∏–∫—É–ª: <input type="text" name="sku" style="width: 100%;"></p>
        <p>–®—Ç—Ä–∏—Ö–∫–æ–¥: <input type="text" name="barcode" style="width: 100%;"></p>
        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫: <input type="number" name="min_stock" style="width: 100%;"></p>
        <p>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: <textarea name="note" style="width: 100%;"></textarea></p>

        <br>
        <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        <button type="button" onclick="document.getElementById('newProductModal').close()">–û—Ç–º–µ–Ω–∞</button>
    </form>
</dialog>

<script>
document.getElementById('add-product').addEventListener('click', function () {
    const container = document.getElementById('products-container');
    const newBlock = container.children[0].cloneNode(true);
    newBlock.querySelectorAll('input').forEach(input => input.value = '');
    container.appendChild(newBlock);
});

let activeSelect = null;

function openNewProductModal(button) {
    activeSelect = button.closest('tr').querySelector("select[name='product']");
    document.getElementById("newProductModal").showModal();
}

document.getElementById("newProductForm").addEventListener("submit", async function (event) {
    event.preventDefault();
    const form = event.target;
    const modal = document.getElementById("newProductModal");

    const formData = new FormData(form);

    const response = await fetch("/logistics/api/create-product/", {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body: formData
    });

    if (!response.ok) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞");
        return;
    }

    const data = await response.json();

    // üëá –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ç–æ–≤–∞—Ä–∞
    const label = [
        data.name,
        data.thickness ? data.thickness + " " + data.unit : "",
        data.format,
        data.grade,
        data.surface
    ].filter(Boolean).join(" ");

    const option = new Option(label, data.id);
    if (activeSelect) {
        activeSelect.appendChild(option);
        activeSelect.value = data.id;
    }

    modal.close();
    form.reset();
});

function toggleCreateButtons() {
    const typeSelect = document.getElementById("id_type");
    const typeValue = typeSelect.value;
    const show = typeValue !== "outgoing"; // outgoing = –†–∞—Å—Ö–æ–¥

    document.querySelectorAll(".create-product-button").forEach(btn => {
        btn.style.display = show ? "inline-block" : "none";
    });
}

document.addEventListener("DOMContentLoaded", function () {
    const typeSelect = document.getElementById("id_type");
    if (typeSelect) {
        typeSelect.addEventListener("change", toggleCreateButtons);
        toggleCreateButtons(); // —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    }
});
</script>
{% endblock %}
